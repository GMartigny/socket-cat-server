
var websocket=require("websocket").server;var http=require("http");var port=process.env.PORT||5000;var httpServer=http.createServer(function(b,a){a.end("<script>location.replace('http://gmartigny.github.com/socket-cats');<\/script>")});httpServer.listen(port);var websocketServer=new websocket({httpServer:httpServer});websocketServer.on("request",function(a){new MyConnection(a)});function MyConnection(b){this.time=Date.now();this.connection=b.accept(null,b.origin);this.user=false;this.emit({type:"list",value:this.everyone()});var a=this;this.connection.on("message",function(c){a.message.call(a,c)});this.connection.on("close",function(){a.close.call(a)});this.nb=MyConnection.list.insert(this)}MyConnection.prototype.message=function(c){if(c.type==="utf8"){var d=JSON.parse(c.utf8Data);if(d.type=="handshake"){var a=new MyUser(d.value.nick,d.value.color),b=false;MyConnection.list.every(function(e){if(e.user&&a.equals(e.user)){b=true;return false}else{return true}});if(b){this.emit({type:"hs-taken",value:""})}else{this.setUser(a);this.emit({type:"hs-isok",value:a.minify()});this.broadcast({type:"arrive",value:a.minify()})}}else{if(d.type=="message"){if(this.user){this.broadcast({type:"message",value:d.value})}}}}};MyConnection.prototype.setUser=function(a){this.user=a;MyConnection.list[this.nb].user=a};MyConnection.prototype.broadcast=function(b){var a=this;MyConnection.list.forEach(function(d){if(d.user!==a.user){d.emit(b)}})};MyConnection.prototype.emit=function(a){this.connection.sendUTF(JSON.stringify(a))};MyConnection.prototype.close=function(){if(this.user){this.broadcast({type:"leave",value:this.user.minify()})}MyConnection.list[this.nb]=undefined;for(var a=MyConnection.list.length-1;a;--a){if(MyConnection.list[a]===undefined){MyConnection.list.pop()}else{break}}};MyConnection.prototype.everyone=function(){var a=[];MyConnection.list.forEach(function(b){if(b.user){a.push(b.user.minify())}});return a};MyConnection.list=[];function MyUser(a,b){this.nick=a;this.color=b}MyUser.prototype.minify=function(){return{nick:this.nick,color:this.color}};MyUser.prototype.equals=function(a){if(a&&this.nick==a.nick&&this.color==a.color){return true}return false};Array.prototype.insert=function(b){for(var a=0;a<=this.length;++a){if(this[a]===undefined){this[a]=b;return a}}};